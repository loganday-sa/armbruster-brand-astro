---
interface Props {
  formId?: string;
}

const { formId = 'DS6kQj' } = Astro.props;
---

<div id="resource-gate" class="resource-gate fixed left-0 right-0 bottom-0 z-40 px-6 pb-6 pt-16 pointer-events-none" role="dialog" aria-modal="true" aria-labelledby="resource-gate-title">
  <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent pointer-events-none"></div>
  <div class="relative max-w-xl mx-auto w-full bg-slate-900/95 border border-slate-700 rounded-2xl p-6 md:p-7 shadow-2xl pointer-events-auto text-center">
    <p class="text-xs uppercase tracking-wide text-blue-400 font-semibold mb-2">Email Unlock</p>
    <h2 id="resource-gate-title" class="text-2xl font-bold mb-3">Unlock The Full Resource</h2>
    <p class="text-slate-300 mb-5 max-w-lg mx-auto">
      You can preview this page. Enter your email to continue reading and unlock PDF downloads.
    </p>

    <div class="flex justify-center">
      <button
        type="button"
        id="open-resource-gate-form"
        class="inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition"
        data-form-id={formId}
      >
        Continue With Email
      </button>
    </div>

    <p class="text-xs text-slate-500 mt-3">
      Already submitted? Refresh once if this remains locked.
    </p>
  </div>
</div>

<script>
  (function () {
    const storageKey = 'resource_gate_unlocked_v1';
    const gate = document.getElementById('resource-gate');
    const openButton = document.getElementById('open-resource-gate-form');
    const formId = openButton?.getAttribute('data-form-id') || 'DS6kQj';
    const originalButtonLabel = openButton?.textContent || 'Continue With Email';
    const lockedDownloadSelector = [
      'a[href*="/downloads/"]',
      'a[href$=".pdf"]',
      '[data-requires-resource-access="true"]',
      '[data-download-pdf]'
    ].join(',');

    const setLockedState = (locked) => {
      document.documentElement.classList.toggle('resource-locked', locked);
      if (!gate) return;
      gate.style.display = locked ? '' : 'none';
      document
        .querySelectorAll(lockedDownloadSelector)
        .forEach((el) => {
          if (!(el instanceof HTMLElement)) return;
          el.classList.toggle('download-locked', locked);
          el.setAttribute('aria-disabled', locked ? 'true' : 'false');
          if (locked) {
            el.setAttribute('tabindex', '-1');
            el.setAttribute('title', 'Enter your email to unlock downloads');
          } else {
            el.removeAttribute('tabindex');
            el.removeAttribute('title');
          }
        });
    };

    const unlock = () => {
      localStorage.setItem(storageKey, '1');
      setLockedState(false);
    };

    const hasAccess = () => localStorage.getItem(storageKey) === '1';

    const query = new URLSearchParams(window.location.search);
    if (query.get('resource_access') === '1') {
      unlock();
      query.delete('resource_access');
      const next = `${window.location.pathname}${query.toString() ? `?${query.toString()}` : ''}${window.location.hash}`;
      window.history.replaceState({}, '', next);
      return;
    }

    if (hasAccess()) {
      setLockedState(false);
      return;
    }

    setLockedState(true);

    openButton?.addEventListener('click', () => {
      openButton.textContent = 'Opening...';
      openButton.setAttribute('disabled', 'true');
      openButton.classList.add('opacity-80', 'cursor-wait');
      if (typeof window.ml === 'function') {
        window.ml('show', formId, true);
      }
      window.setTimeout(() => {
        openButton.textContent = originalButtonLabel;
        openButton.removeAttribute('disabled');
        openButton.classList.remove('opacity-80', 'cursor-wait');
      }, 3000);
    });

    document.addEventListener('click', (event) => {
      if (!document.documentElement.classList.contains('resource-locked')) {
        return;
      }

      const target = event.target;
      if (!(target instanceof Element)) return;
      const blockedEl = target.closest(lockedDownloadSelector);
      if (!blockedEl) return;

      event.preventDefault();
      event.stopPropagation();
      if (typeof window.ml === 'function') {
        window.ml('show', formId, true);
      }
    }, true);

    window.addEventListener('message', (event) => {
      if (typeof event.origin !== 'string' || !event.origin.includes('mailerlite')) {
        return;
      }

      const payload = typeof event.data === 'string'
        ? event.data.toLowerCase()
        : JSON.stringify(event.data).toLowerCase();

      if (
        payload.includes('success') ||
        payload.includes('subscribed') ||
        payload.includes('subscriber') ||
        payload.includes('form_submitted')
      ) {
        unlock();
      }
    });
  })();
</script>
